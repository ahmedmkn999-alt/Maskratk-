<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة معسكراتك | الأكاديمية</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root { --primary: #FFD700; --bg: #050505; --panel: #151515; --text: #fff; --hover: #222; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); overflow-x: hidden; }

        /* شاشة الدخول */
        #login-gate { position: fixed; inset: 0; background: #000; z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .gate-box { background: #111; padding: 40px; border-radius: 20px; border: 1px solid #333; text-align: center; width: 90%; max-width: 400px; }
        .gate-input { width: 100%; padding: 15px; margin: 20px 0; background: #000; border: 1px solid #333; color: var(--primary); text-align: center; font-size: 1.2rem; border-radius: 10px; }
        .gate-btn { background: var(--primary); color: #000; padding: 10px 40px; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; }

        /* الهيدر ومسار التنقل */
        header { padding: 20px 5%; background: #111; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 15px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; }
        .brand { font-weight: 800; font-size: 1.5rem; color: #fff; }
        .brand span { color: var(--primary); }
        
        /* Breadcrumbs (شريط التنقل) */
        .breadcrumbs { display: flex; gap: 10px; font-size: 0.9rem; color: #888; align-items: center; overflow-x: auto; white-space: nowrap; }
        .breadcrumb-item { cursor: pointer; transition: 0.2s; }
        .breadcrumb-item:hover { color: #fff; }
        .breadcrumb-item.active { color: var(--primary); font-weight: bold; cursor: default; }
        .separator { color: #444; }

        /* الحاويات */
        #platform { display: none; min-height: 100vh; }
        .container { padding: 30px 5%; max-width: 1400px; margin: 0 auto; }

        /* Grid System للاختيارات */
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; animation: fadeIn 0.5s; }
        
        .card { 
            background: var(--panel); border: 1px solid #333; border-radius: 15px; overflow: hidden; 
            cursor: pointer; transition: 0.3s; position: relative; text-align: center; padding-bottom: 15px;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .card-img { width: 100%; height: 180px; object-fit: cover; background: #222; }
        .card-title { font-weight: 700; margin-top: 15px; font-size: 1.1rem; padding: 0 10px; }
        .card-subtitle { font-size: 0.85rem; color: #888; margin-top: 5px; }

        /* واجهة الفيديو (للمستوى الأخير) */
        .video-layout { display: none; grid-template-columns: 1fr 350px; gap: 20px; height: calc(100vh - 150px); animation: fadeIn 0.5s; }
        
        .video-container { background: #000; border-radius: 15px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid #333; }
        .player-wrapper { flex: 1; background: #000; position: relative; }
        video { width: 100%; height: 100%; }
        
        .playlist { background: var(--panel); border-radius: 15px; border: 1px solid #333; overflow-y: auto; display: flex; flex-direction: column; }
        .playlist-header { padding: 15px; background: #222; font-weight: bold; border-bottom: 1px solid #333; position: sticky; top: 0; }
        
        /* القوائم المنسدلة داخل البلاي ليست */
        .chapter-group { border-bottom: 1px solid #333; }
        .chapter-title { padding: 12px 15px; background: #1a1a1a; cursor: pointer; display: flex; justify-content: space-between; font-size: 0.9rem; color: #aaa; }
        .chapter-title:hover { color: #fff; }
        .videos-list { display: none; }
        .videos-list.open { display: block; }
        
        .video-item { padding: 12px 15px; border-bottom: 1px solid #222; cursor: pointer; display: flex; align-items: center; font-size: 0.9rem; transition: 0.2s; background: #111; }
        .video-item:hover { background: #222; }
        .video-item.active { background: rgba(255, 215, 0, 0.1); border-right: 3px solid var(--primary); color: var(--primary); }

        /* رسالة خطأ الفيديو */
        .error-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); color: #ff4444; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 900px) { .video-layout { grid-template-columns: 1fr; height: auto; } .playlist { max-height: 500px; } }
    </style>
</head>
<body>

    <div id="login-gate">
        <div class="gate-box">
            <h1 style="color: #fff; margin-bottom: 10px;">أكاديمية معسكراتك</h1>
            <input type="password" id="access-code" class="gate-input" placeholder="الكود السري">
            <button class="gate-btn" onclick="checkCode()">دخول</button>
            <p id="error-msg" style="color: red; margin-top: 10px; display: none;">الكود غير صحيح</p>
        </div>
    </div>

    <div id="platform">
        <header>
            <div class="top-bar">
                <div class="brand">MASK<span>ARATAK</span></div>
                <div id="user-name" style="color: #888; font-size: 0.9rem;">طالب</div>
            </div>
            <div class="breadcrumbs" id="breadcrumbs">
                <span class="breadcrumb-item active">الرئيسية</span>
            </div>
        </header>

        <div class="container">
            <div id="grid-container" class="grid-view"></div>

            <div id="video-layout" class="video-layout">
                <div class="video-container">
                    <div class="player-wrapper">
                        <div id="error-overlay" class="error-overlay">
                            <h3>⚠️ عذراً</h3><p>الرابط منتهي الصلاحية</p>
                        </div>
                        <video id="main-player" controls playsinline></video>
                    </div>
                    <div style="padding: 15px; border-top: 1px solid #333;">
                        <h3 id="current-video-title" style="color: var(--primary);">اختر درساً</h3>
                    </div>
                </div>
                <div class="playlist" id="playlist-container"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVWCxTVgg3i25jJ0LbZOxpB4mfQc_BnQs",
            authDomain: "maskratk.firebaseapp.com",
            projectId: "maskratk",
            storageBucket: "maskratk.firebasestorage.app",
            messagingSenderId: "857906406354",
            appId: "1:857906406354:web:c19538fd2824b9a64d5e0b",
            measurementId: "G-E3018VB921"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- البيانات الضخمة (التي أرسلتها) ---
        // تم دمج البيانات هنا كمتغير ثابت
        const fullData = [
          {
            "subjects": [
              {
                "subject_id": 40,
                "subject_name": "لغة عربية",
                "image_url": "https://files.coursatk.online/images/questions/c91723a0f73a35ed26c7c35a47d99f7e02c66e55b552.jpg",
                "teachers": [
                  {
                    "id": 110, "name": "أ.محمد صلاح",
                    "image_url": "https://files.coursatk.online/images/questions/abc2fcc42883dd1a9e93021922da73dc92ff4b40ec76.jpg",
                    "chapters": [
                        // تم اختصار البيانات هنا للعرض، انسخ البيانات الكاملة من رسالتك السابقة وضعها هنا داخل هذا المصفوفة
                        // ... (ضع محتوى JSON الكامل الذي أرسلته لي هنا) ...
                    ]
                  }
                ]
              },
              {
                "subject_id": 48,
                "subject_name": "رياضة",
                "image_url": "https://files.coursatk.online/images/subjects/math.png",
                "teachers": [
                   // ... بيانات الرياضة ...
                ]
              },
              {
                "subject_id": 46,
                "subject_name": "جغرافيا",
                "image_url": "https://files.coursatk.online/images/subjects/geography.png",
                "teachers": [
                   // ... بيانات الجغرافيا ...
                ]
              }
            ]
          }
        ];
        
        // ملاحظة: بما أنك أرسلت JSON ضخم، سأقوم بوضع الكود الذي يعالج الهيكل الذي أرسلته بالظبط.
        // أنت ستقوم بنسخ الـ JSON الكامل الذي أرسلته لي في رسالتك السابقة وتضعه داخل المتغير `rawData` بالأسفل.

        let rawData = []; // سيتم ملؤها لاحقاً بالدالة

        // --- إدارة الحالة (Navigation State) ---
        let navigationState = {
            step: 0, // 0: Subjects, 1: Teachers, 2: Chapters, 3: Videos
            currentSubject: null,
            currentTeacher: null,
            currentChapter: null
        };

        // --- دوال التشغيل ---
        window.checkCode = async function() {
            const code = document.getElementById('access-code').value;
            // للسرعة سنستخدم الكود الثابت مع قاعدة البيانات
            const q = query(collection(db, "access_codes"), where("code", "==", code));
            
            try {
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    const data = snapshot.docs[0].data();
                    document.getElementById('user-name').innerText = data.name;
                    document.getElementById('login-gate').style.display = 'none';
                    document.getElementById('platform').style.display = 'block';
                    
                    // هنا سنقوم بتحميل البيانات (افترضنا أنك وضعت البيانات في المتغير بالأسفل)
                    // بما أن الكود طويل، سأفترض أنك وضعت الـ JSON الخاص بك في المتغير `serverData`
                    initData(); 
                } else {
                    document.getElementById('error-msg').style.display = 'block';
                }
            } catch(e) { console.log(e); alert("خطأ في الاتصال"); }
        }

        function initData() {
            // هنا ضع الـ JSON الكامل الذي أرسلته لي
            // أنا سأضع الهيكل الأساسي ليعمل الكود، وعليك نسخ المحتوى ولصقه هنا
            rawData = [
               // >>>>> انسخ كل الـ JSON الذي أرسلته لي هنا <<<<<
               // مثال للتوضيح:
               {
                 "subjects": [
                    {
                        "subject_name": "لغة عربية",
                        "image_url": "https://files.coursatk.online/images/questions/c91723a0f73a35ed26c7c35a47d99f7e02c66e55b552.jpg",
                        "teachers": [
                            {
                                "name": "أ.محمد صلاح",
                                "image_url": "https://files.coursatk.online/images/questions/abc2fcc42883dd1a9e93021922da73dc92ff4b40ec76.jpg",
                                "chapters": [
                                    // ... انسخ باقي البيانات هنا ...
                                ]
                            }
                        ]
                    },
                    // ... انسخ باقي المواد ...
                 ]
               }
            ]; 
            
            // لو لم تقم بالنسخ، الكود لن يعمل. هذا مجرد مثال.
            // *هام*: قم بنسخ الـ JSON كاملاً وضعه مكان المصفوفة أعلاه.
            
            // في الواقع، البيانات التي أرسلتها هي مصفوفة تحتوي على كائن واحد به subjects
            // لذا سنصل لها هكذا:
            if(rawData[0] && rawData[0].subjects) {
                renderSubjects();
            } else {
                alert("يرجى وضع البيانات (JSON) داخل الكود!");
            }
        }

        // 1. عرض المواد
        function renderSubjects() {
            const grid = document.getElementById('grid-container');
            const vidLayout = document.getElementById('video-layout');
            grid.innerHTML = '';
            grid.style.display = 'grid';
            vidLayout.style.display = 'none';
            updateBreadcrumbs(0);

            const subjects = rawData[0].subjects; // الوصول للمواد من الداتا

            subjects.forEach(sub => {
                const card = createCard(sub.subject_name, 'مادة دراسية', sub.image_url);
                card.onclick = () => renderTeachers(sub);
                grid.appendChild(card);
            });
        }

        // 2. عرض المدرسين
        function renderTeachers(subject) {
            navigationState.currentSubject = subject;
            const grid = document.getElementById('grid-container');
            grid.innerHTML = '';
            updateBreadcrumbs(1);

            subject.teachers.forEach(teacher => {
                const card = createCard(teacher.name, subject.subject_name, teacher.image_url);
                card.onclick = () => renderChapters(teacher);
                grid.appendChild(card);
            });
        }

        // 3. عرض الفصول/الأشهر (Chapters)
        function renderChapters(teacher) {
            navigationState.currentTeacher = teacher;
            const grid = document.getElementById('grid-container');
            grid.innerHTML = '';
            updateBreadcrumbs(2);

            teacher.chapters.forEach(chapter => {
                const card = createCard(chapter.chapter_name, teacher.name, chapter.image_url);
                card.onclick = () => renderVideosView(chapter);
                grid.appendChild(card);
            });
        }

        // 4. عرض واجهة الفيديو (Lectures & Videos)
        function renderVideosView(chapter) {
            navigationState.currentChapter = chapter;
            const grid = document.getElementById('grid-container');
            const vidLayout = document.getElementById('video-layout');
            const playlist = document.getElementById('playlist-container');
            
            grid.style.display = 'none';
            vidLayout.style.display = 'grid';
            updateBreadcrumbs(3);
            
            playlist.innerHTML = `<div class="playlist-header">${chapter.chapter_name}</div>`;

            // في بياناتك: Chapters تحتوي على Lectures، والـ Lectures تحتوي على Videos
            chapter.lectures.forEach((lecture, index) => {
                const group = document.createElement('div');
                group.className = 'chapter-group';
                
                // عنوان المحاضرة (زر لفتح القائمة)
                const title = document.createElement('div');
                title.className = 'chapter-title';
                title.innerHTML = `<span>${lecture.lecture_name}</span> <span>▼</span>`;
                
                const list = document.createElement('div');
                list.className = 'videos-list';
                if(index === 0) list.classList.add('open'); // فتح أول قائمة تلقائياً

                title.onclick = () => list.classList.toggle('open');

                // الفيديوهات داخل المحاضرة
                lecture.videos.forEach(vid => {
                    const vidItem = document.createElement('div');
                    vidItem.className = 'video-item';
                    vidItem.innerHTML = `<span>▶ ${vid.video_name}</span>`;
                    // نأخذ أول رابط متاح (غالباً 720)
                    const url = vid.links && vid.links.length > 0 ? vid.links[0].url : '';
                    
                    vidItem.onclick = () => {
                        playVideo(url, vid.video_name);
                        document.querySelectorAll('.video-item').forEach(i => i.classList.remove('active'));
                        vidItem.classList.add('active');
                    };
                    list.appendChild(vidItem);
                });

                group.appendChild(title);
                group.appendChild(list);
                playlist.appendChild(group);
            });
        }

        // --- المساعدات (Helpers) ---
        function createCard(title, subtitle, img) {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <img src="${img}" class="card-img" onerror="this.src='https://via.placeholder.com/300?text=Coursatk'">
                <div class="card-title">${title}</div>
                <div class="card-subtitle">${subtitle}</div>
            `;
            return div;
        }

        function updateBreadcrumbs(level) {
            const container = document.getElementById('breadcrumbs');
            let html = `<span class="breadcrumb-item" onclick="window.renderSubjects()">الرئيسية</span>`;
            
            if (level >= 1) {
                html += ` <span class="separator">></span> <span class="breadcrumb-item" onclick="renderTeachers(navigationState.currentSubject)">${navigationState.currentSubject.subject_name}</span>`;
            }
            if (level >= 2) {
                html += ` <span class="separator">></span> <span class="breadcrumb-item" onclick="renderChapters(navigationState.currentTeacher)">${navigationState.currentTeacher.name}</span>`;
            }
            if (level >= 3) {
                html += ` <span class="separator">></span> <span class="breadcrumb-item active">${navigationState.currentChapter.chapter_name}</span>`;
            }
            
            container.innerHTML = html;
            // لازم نربط الدوال بالـ window عشان الـ HTML يشوفها
            window.renderSubjects = renderSubjects;
            window.renderTeachers = (sub) => { navigationState.currentSubject = sub; renderTeachers(sub); };
            window.renderChapters = (tea) => { navigationState.currentTeacher = tea; renderChapters(tea); };
        }

        function playVideo(url, title) {
            const video = document.getElementById('main-player');
            const errorOverlay = document.getElementById('error-overlay');
            document.getElementById('current-video-title').innerText = title;
            errorOverlay.style.display = 'none';

            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                hls.on(Hls.Events.ERROR, (e, data) => { if(data.fatal) errorOverlay.style.display = 'flex'; });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.addEventListener('loadedmetadata', () => video.play());
                video.addEventListener('error', () => errorOverlay.style.display = 'flex');
            }
        }
    </script>
</body>
</html>
